<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>Tic-Tac-Toe</title>
    <style>
        .board {
            display: grid;
            grid-template-columns: repeat(3, 100px);
            grid-gap: 2px;
            margin: 20px auto;
            width: 306px;
        }
        .cell {
            width: 100px;
            height: 100px;
            background: #f0f0f0;
            border: 1px solid #ccc;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            cursor: pointer;
        }
        .cell:hover { background: #e0e0e0; }
        .cell.disabled { cursor: not-allowed; opacity: 0.5; }
        #status { text-align: center; margin: 20px; }
    </style>
</head>
<body>
    <div id="status">Waiting for game to start...</div>
    <div class="board" id="board"></div>

    <script>
        const gameAPI = window.gameAPI;

        let board = Array(9).fill('');
        let currentPlayer = '';
        let mySymbol = '';
        let gameActive = false;

        function initBoard() {
            const boardEl = document.getElementById('board');
            boardEl.innerHTML = '';
            for (let i = 0; i < 9; i++) {
                const cell = document.createElement('div');
                cell.className = 'cell';
                cell.dataset.index = i;
                cell.onclick = () => makeMove(i);
                boardEl.appendChild(cell);
            }
        }

        function makeMove(index) {
            if (!gameActive || board[index] || currentPlayer !== mySymbol) return;

            gameAPI.sendMove(`MOVE ${index} ${mySymbol}`);
        }

        function updateBoard() {
            const cells = document.querySelectorAll('.cell');
            cells.forEach((cell, index) => {
                cell.textContent = board[index];
                cell.classList.toggle('disabled',
                    !gameActive || board[index] || currentPlayer !== mySymbol);
            });
        }

        function updateStatus(message) {
            document.getElementById('status').textContent = message;
        }

        gameAPI.onMessage((message) => {
            const parts = message.split(' ');
            const command = parts[0];

            switch (command) {
                case 'START':
                    mySymbol = parts[1];
                    currentPlayer = 'X';
                    gameActive = true;
                    updateStatus(`Game started! You are ${mySymbol}. ${
                        currentPlayer === mySymbol ? 'Your turn' : 'Opponent\'s turn'
                    }`);
                    break;

                case 'MOVE':
                    const position = parseInt(parts[1]);
                    const player = parts[2];
                    board[position] = player;
                    updateBoard();
                    break;

                case 'TURN':
                    currentPlayer = parts[1];
                    updateStatus(currentPlayer === mySymbol ? 'Your turn' : 'Opponent\'s turn');
                    break;

                case 'END':
                    gameActive = false;
                    const result = parts[1];
                    if (result === 'DRAW') {
                        updateStatus('Game ended in a draw!');
                    } else if (result === mySymbol) {
                        updateStatus('You won!');
                    } else {
                        updateStatus('You lost!');
                    }
                    break;

                case 'ERROR':
                    updateStatus('Error: ' + parts.slice(1).join(' '));
                    break;
            }
        });

        initBoard();
        updateBoard();
    </script>
</body>
</html>
