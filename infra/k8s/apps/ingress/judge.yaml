# Judge WebSocket Ingress - Handles WebSocket connections with sticky sessions
# HTTPS/WSS with automatic TLS certificates
# Requires: A domain name pointing to the NGINX Ingress LoadBalancer
# Access: wss://judge.${DOMAIN_NAME}/ws/{game_id}/{room_id}
#
# Routing Strategy:
# - WebSocket connections are routed by room_id for sticky sessions
# - All players in same room connect to same Judge instance
# - room_id is extracted from URL path and used for consistent hashing
#
# Deploy with:
#   export DOMAIN_NAME="yourdomain.com"
#   envsubst < judge.yaml | kubectl apply -f -
apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  name: judge-websocket
  namespace: backend
  annotations:
    nginx.ingress.kubernetes.io/ssl-redirect: "true"
    nginx.ingress.kubernetes.io/force-ssl-redirect: "true"
    cert-manager.io/cluster-issuer: "letsencrypt-${CERT_ISSUER}"
    # WebSocket specific settings
    nginx.ingress.kubernetes.io/websocket-services: "judge"
    nginx.ingress.kubernetes.io/proxy-read-timeout: "86400"  # 24 hours
    nginx.ingress.kubernetes.io/proxy-send-timeout: "86400"  # 24 hours
    # Sticky sessions by room_id (configured globally in ingress-nginx-values.yaml)
    nginx.ingress.kubernetes.io/upstream-hash-by: "$room_id"
spec:
  ingressClassName: nginx
  tls:
    - hosts:
        - judge.${DOMAIN_NAME}
      secretName: judge-tls-cert
  rules:
    - host: judge.${DOMAIN_NAME}
      http:
        paths:
          # WebSocket endpoints (sticky sessions by room_id)
          - path: /ws
            pathType: Prefix
            backend:
              service:
                name: judge
                port:
                  number: 8081
